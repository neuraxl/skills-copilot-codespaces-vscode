<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuraX-Ultime ‚Äî Interface Centrale</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <script>
        // Configuration Tailwind pour d√©finir des couleurs et ombres personnalis√©es
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'dark-bg': '#0d0d1a',
                        'neon-cyan': '#00ffe0',
                        'dark-header': 'rgba(10, 10, 30, 0.9)',
                        'dark-card': 'rgba(255, 255, 255, 0.05)',
                        'status-green': '#32ff87',
                        'status-red': '#ff4757',
                        'status-yellow': '#ffbe2e',
                        // Couleur sp√©cifique pour le QFS/SFQ
                        'qfs-purple': '#a855f7', 
                        // Nouvelle couleur pour le d√©ploiement global
                        'deploy-blue': '#3b82f6',
                        // Couleur pour le Pilier de Gouvernance
                        'gov-orange': '#f97316', 
                    },
                    boxShadow: {
                        // Ombre personnalis√©e pour l'effet de lueur n√©on
                        'neon-glow': '0 0 15px rgba(0, 255, 224, 0.6)',
                        'neon-glow-sm': '0 0 5px rgba(0, 255, 224, 0.4)',
                        'qfs-glow': '0 0 15px rgba(168, 85, 247, 0.6)',
                        'deploy-glow': '0 0 15px rgba(59, 130, 246, 0.6)',
                        'gov-glow': '0 0 15px rgba(249, 115, 22, 0.6)',
                    },
                    // D√©grad√© de fond personnalis√© correspondant √† l'original
                    backgroundImage: {
                        'radial-dark': 'radial-gradient(circle at center, var(--tw-colors-dark-bg), #000)',
                    }
                }
            }
        }
    </script>
    <style>
        /* Applique le d√©grad√© de fond personnalis√© au corps */
        body {
            background: radial-gradient(circle at center, #0d0d1a, #000);
            min-height: 100vh;
        }
        /* Style pour l'effet de flou de l'en-t√™te */
        header {
            background: rgba(10, 10, 30, 0.9);
            backdrop-filter: blur(5px);
        }
        /* Style de la barre de progression */
        .progress-bar {
            height: 6px;
            border-radius: 9999px;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .progress-fill {
            height: 100%;
            border-radius: 9999px;
            background-color: var(--tw-colors-neon-cyan);
            box-shadow: 0 0 5px var(--tw-colors-neon-cyan);
            transition: width 0.5s ease-out;
        }
        /* Style pour la fen√™tre de logs pour un aspect terminal */
        #systemLog {
            font-size: 0.75rem; /* Plus petit pour ressembler √† des logs */
            line-height: 1.4;
            height: 400px; /* Hauteur fixe pour le d√©filement */
        }
        /* Pour les petits √©crans, ajuster la hauteur des logs */
        @media (min-width: 1024px) {
            #systemLog {
                height: 100%; /* S'adapte au conteneur sur desktop */
            }
        }
        /* Pour les listes dans les cartes */
        .card ul, .card ol {
            list-style-type: disc;
            margin-left: 1.25rem;
            margin-top: 0.5rem;
        }
        /* Animation clignotante pour le statut de d√©ploiement */
        @keyframes pulse-deployment {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .animate-pulse-deployment {
            animation: pulse-deployment 1.5s infinite;
        }
    </style>
</head>
<body class="text-gray-200 font-sans antialiased">

    <!-- Global Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-dark-bg bg-opacity-90 z-50 flex flex-col items-center justify-center hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-neon-cyan"></div>
        <p id="loadingMessage" class="mt-4 text-lg text-neon-cyan">Initialisation du R√©seau NeuraX...</p>
    </div>

    <!-- Header Section -->
    <header class="p-6 text-center border-b border-gray-800 sticky top-0 z-10">
        <h1 class="text-3xl sm:text-4xl text-neon-cyan shadow-neon-glow transition duration-500 ease-in-out">
            üß† NeuraX‚ÄëUltime ‚Äî Interface Centrale
        </h1>
        <p class="text-sm sm:text-base text-gray-400 mt-1">
            Le Cerveau Virtuel Universel ‚Äî Commandes et Diagnostics
        </p>
    </header>

    <!-- Main Dashboard Container -->
    <main class="p-6 sm:p-8 lg:p-12 max-w-7xl mx-auto">
        
        <!-- TWO COLUMN LAYOUT (Desktop) / STACKED (Mobile) -->
        <div class="lg:grid lg:grid-cols-12 lg:gap-8">
            
            <!-- LEFT COLUMN: COMMANDS, METRICS, CARDS (lg:col-span-8) -->
            <div class="lg:col-span-8">

                <!-- 1. Command and Search Bar (Focus principal) -->
                <section class="mb-10">
                    <h2 class="text-xl font-light text-neon-cyan mb-3">Console de Commande C√©r√©brale</h2>
                    <div class="relative">
                        <input id="commandInput" type="text" placeholder="Entrez une commande, une requ√™te ou une fonction (ex: 'deployer sfq' ou 'gouvernance protocole')" 
                            class="w-full bg-dark-card border border-neon-cyan/50 text-white p-4 pr-16 rounded-lg focus:outline-none focus:ring-2 focus:ring-neon-cyan/80 transition duration-300 placeholder-gray-500 shadow-neon-glow-sm"
                            autofocus>
                        <button onclick="executeCommand()" class="absolute right-3 top-1/2 transform -translate-y-1/2 p-2 bg-neon-cyan rounded-full text-dark-bg hover:bg-[#00c9aa] transition duration-200">
                            <!-- Icone de fl√®che vers la droite -->
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <!-- Zone pour afficher les messages de retour -->
                    <div id="commandOutput" class="mt-3 text-sm text-gray-400 min-h-[50px] bg-dark-card/50 p-2 rounded-lg" role="alert">
                        <span id="outputMessage">Syst√®me en veille. Entrez une commande pour interagir.</span>
                        <div id="sourcesContainer" class="text-xs mt-2 italic text-gray-500 hidden">
                            Sources:
                        </div>
                    </div>
                    <!-- Affichage de l'ID Utilisateur Actuel -->
                    <div class="text-xs text-gray-500 mt-2">
                        <span class="text-neon-cyan font-bold">Op√©rateur ID:</span> <span id="currentUserId">... chargement ...</span>
                    </div>
                </section>

                <!-- 2. System Status Metrics (Efficacit√© et Diagnostic) -->
                <section class="mb-10">
                    <h2 class="text-xl font-light text-neon-cyan mb-4 border-b border-gray-800 pb-2">Diagnostics et Statut Neuronal en Temps R√©el</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        
                        <!-- Stat Card: Processor Load -->
                        <div class="p-4 bg-dark-card rounded-xl border border-gray-800 shadow-lg">
                            <p class="text-xs font-semibold text-gray-400 uppercase">Charge Processeur</p>
                            <div class="text-2xl font-bold text-status-green mt-1" id="cpuLoad">12.4%</div>
                            <div class="progress-bar mt-2"><div class="progress-fill bg-status-green shadow-green-glow" style="width: 12.4%"></div></div>
                        </div>

                        <!-- Stat Card: QFS Deployment Status (NEW) -->
                        <div class="p-4 bg-dark-card rounded-xl border border-deploy-blue/80 shadow-deploy-glow">
                            <p class="text-xs font-semibold text-gray-400 uppercase">SFQ N≈ìuds Op√©rationnels</p>
                            <div class="text-2xl font-bold text-deploy-blue mt-1" id="sfqNodes">0/240</div>
                            <p class="text-xs text-gray-500 mt-1" id="sfqStatus">D√©ploiement en Attente</p>
                        </div>

                        <!-- Stat Card: Network Latency -->
                        <div class="p-4 bg-dark-card rounded-xl border border-gray-800 shadow-lg">
                            <p class="text-xs font-semibold text-gray-400 uppercase">Latence R√©seau</p>
                            <div class="text-2xl font-bold text-neon-cyan mt-1" id="latency">~5 ms</div>
                            <p class="text-xs text-gray-500 mt-1">Stabilit√© Optimale</p>
                        </div>

                        <!-- Stat Card: QFS Signature -->
                        <div class="p-4 bg-dark-card rounded-xl border border-gray-800 shadow-lg">
                            <p class="text-xs font-semibold text-gray-400 uppercase">QFS Signature</p>
                            <div class="text-2xl font-bold mt-1" id="qfsStatus" style="color: var(--tw-colors-qfs-purple);">
                                <span class="text-qfs-purple">EN LIGNE</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Taux Rotation: 12h</p>
                        </div>
                    </div>
                </section>

                <!-- 3. Core Feature Cards (Grille optimis√©e) -->
                <section class="mb-10">
                    <h2 class="text-xl font-light text-neon-cyan mb-4 border-b border-gray-800 pb-2">Modules Fonctionnels Principaux</h2>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        
                        <!-- Card: SFQ Global Deployment (MAINTAINED) -->
                        <div class="card bg-dark-card border border-deploy-blue/80 rounded-xl p-6 transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-2xl" style="box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);">
                            <h2 class="text-lg font-semibold text-deploy-blue border-b border-deploy-blue/50 pb-2 mb-3">üåê D√©ploiement SFQ Global</h2>
                            <p class="text-sm leading-relaxed text-gray-300 mb-4">
                                Simule le d√©ploiement de 240 n≈ìuds SFQ √† travers le monde. Requis pour l'interop√©rabilit√©.
                            </p>
                            <button id="deployButton" onclick="startSFQDeployment()" class="w-full bg-deploy-blue/20 text-deploy-blue border border-deploy-blue p-3 rounded-lg font-bold hover:bg-deploy-blue hover:text-dark-bg transition duration-200">
                                D√©marrer D√©ploiement SFQ
                            </button>
                        </div>

                        <!-- Card: Protocole de S√©curit√© QFS (MAINTAINED) -->
                        <div class="card bg-dark-card border border-qfs-purple/80 rounded-xl p-6 transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-2xl" style="box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);">
                            <h2 class="text-lg font-semibold text-qfs-purple border-b border-qfs-purple/50 pb-2 mb-3">üîí Protocole de S√©curit√© QFS</h2>
                            <p class="text-sm leading-relaxed text-gray-300 mb-4">
                                Active la Poign√©e de Main Quantique pour une authentification post-quantique et une s√©curit√© des donn√©es maximum.
                            </p>
                            <button onclick="initiateQuantumHandshake()" class="w-full bg-qfs-purple/20 text-qfs-purple border border-qfs-purple p-3 rounded-lg font-bold hover:bg-qfs-purple hover:text-dark-bg transition duration-200">
                                Initi√© le Quantum Handshake
                            </button>
                        </div>
                        
                        <!-- Card: G√âN√âRATION DE STANDARD SFQ (NEW - Structured JSON) -->
                        <div class="card bg-dark-card border border-gov-orange/80 rounded-xl p-6 transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-2xl hover:shadow-gov-orange/50">
                            <h2 class="text-lg font-semibold text-gov-orange border-b border-gov-orange/50 pb-2 mb-3">‚öñÔ∏è G√©n√©ration de Standard SFQ ‚ú®</h2>
                            <p class="text-sm leading-relaxed text-gray-300 mb-4">
                                √âtablit un protocole structur√© (s√©curit√©, conformit√©, interop√©rabilit√©) pour l'adoption r√©glementaire mondiale du SFQ.
                            </p>
                            <button onclick="requestSFQStandardization()" class="w-full bg-gov-orange/20 text-gov-orange border border-gov-orange p-3 rounded-lg font-bold hover:bg-gov-orange hover:text-dark-bg transition duration-200">
                                G√©n√©rer Rapport de Gouvernance
                            </button>
                        </div>
                        
                        <!-- Card: Synth√®se Quantique (LLM Feature Card 1) -->
                        <div class="card bg-dark-card border border-gray-800 rounded-xl p-6 transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-2xl hover:shadow-neon-cyan/50">
                            <h2 class="text-lg font-semibold text-neon-cyan border-b border-gray-700 pb-2 mb-3">üß© Synth√®se Quantique ‚ú®</h2>
                            <p class="text-sm leading-relaxed text-gray-300 mb-4">
                                L'IA analyse les donn√©es syst√®me complexes et en tire des conclusions analytiques concises.
                            </p>
                            <button onclick="analyzeSystemStatus()" class="w-full bg-status-green/20 text-status-green border border-status-green p-3 rounded-lg font-bold hover:bg-status-green hover:text-dark-bg transition duration-200">
                                Analyser le Statut Actuel
                            </button>
                        </div>


                        <!-- Card: Synth√®se Vocale (LLM TTS Feature Card 2) -->
                        <div class="card bg-dark-card border border-gray-800 rounded-xl p-6 transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-2xl hover:shadow-neon-cyan/50">
                            <h2 class="text-lg font-semibold text-neon-cyan border-b border-gray-700 pb-2 mb-3">üîä Synth√®se Vocale TTS ‚ú®</h2>
                            <p class="text-sm leading-relaxed text-gray-300 mb-4">
                                Fait lire le dernier message de la console de commande par l'IA centrale (Voix $Kore$).
                            </p>
                            <button id="ttsButton" onclick="readLastOutput()" class="w-full bg-neon-cyan/20 text-neon-cyan border border-neon-cyan p-3 rounded-lg font-bold hover:bg-neon-cyan hover:text-dark-bg transition duration-200">
                                Lire la Derni√®re Sortie
                            </button>
                            <audio id="systemAudio" class="hidden"></audio>
                        </div>

                        <!-- Card: G√©n√©ration d'Image de Concept (LLM Image Feature 4) -->
                        <div class="card bg-dark-card border border-gray-800 rounded-xl p-6 transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-2xl hover:shadow-neon-cyan/50">
                            <h2 class="text-lg font-semibold text-neon-cyan border-b border-gray-700 pb-2 mb-3">üñºÔ∏è G√©n√©ration de Concept ‚ú®</h2>
                            <p class="text-sm leading-relaxed text-gray-300 mb-4">
                                Visualise n'importe quel concept syst√®me ou futuriste en utilisant l'IA (Imagen 3.0).
                            </p>
                            <button onclick="generateConceptImage()" class="w-full bg-status-yellow/20 text-status-yellow border border-status-yellow p-3 rounded-lg font-bold hover:bg-status-yellow hover:text-dark-bg transition duration-200">
                                G√©n√©rer une Image Concept
                            </button>
                        </div>

                    </div>
                </section>
            </div>

            <!-- RIGHT COLUMN: LOGS & MONITORING (lg:col-span-4) -->
            <div class="lg:col-span-4 mt-8 lg:mt-0">
                
                <!-- Tableau des Utilisateurs Actifs (MAINTAINED) -->
                <div class="bg-dark-card border border-gray-700 rounded-xl p-6 mb-8 shadow-neon-glow-sm">
                    <h2 class="text-xl font-light text-status-green mb-4 border-b border-gray-800 pb-2">Utilisateurs Actifs & Activit√© API</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-left text-xs font-mono">
                            <thead>
                                <tr class="text-gray-400 uppercase border-b border-gray-700">
                                    <th class="py-2 px-1">ID (UID)</th>
                                    <th class="py-2 px-1">Derni√®re Action</th>
                                </tr>
                            </thead>
                            <tbody id="userActivityTableBody" class="divide-y divide-gray-800">
                                <!-- Les lignes d'activit√© seront ins√©r√©es ici par JS (Firestore) -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Logs Critiques -->
                <div class="bg-dark-card border border-gray-700 rounded-xl p-6 h-full flex flex-col shadow-neon-glow-sm">
                    <h2 class="text-xl font-light text-status-yellow mb-4 border-b border-gray-800 pb-2">Logs Critiques NeuraX</h2>
                    <div id="systemLog" class="flex-grow overflow-y-scroll text-gray-400 font-mono space-y-1">
                        <!-- Logs ins√©r√©es ici par JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Start Button Section (Reste au centre de la page) -->
        <div class="text-center pb-10">
            <a href="#" class="inline-block bg-neon-cyan text-dark-bg p-4 px-10 rounded-full font-extrabold mt-8 shadow-neon-glow transition duration-300 ease-in-out hover:scale-[1.05] hover:bg-[#00c9aa] text-lg">
                üöÄ D√©marrer le Cerveau
            </a>
        </div>
    </main>

    <!-- Footer Section -->
    <footer class="text-center p-5 text-sm text-gray-600 border-t border-gray-800">
        &copy; 2025 Sav'art ‚Äî Projet NeuraX‚ÄëUltime | Cr√©ation, Simulation et Intelligence Po√©tique.
    </footer>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase objects globally for the main script
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            getFirestore, doc, setDoc, onSnapshot, collection, serverTimestamp, setLogLevel
        };
    </script>

    <!-- Script JavaScript pour simuler la commande et les donn√©es en temps r√©el et int√©grer l'API Gemini -->
    <script>
        const apiKey = ""; // Cl√© API laiss√©e vide pour la gestion automatique par Canvas
        const systemLog = document.getElementById('systemLog');
        const cpuLoadElement = document.getElementById('cpuLoad');
        const qfsStatusElement = document.getElementById('qfsStatus'); 
        const sfqNodesElement = document.getElementById('sfqNodes'); // New SFQ Nodes element
        const sfqDeploymentStatusElement = document.getElementById('sfqStatus'); // New SFQ Deployment status
        const deployButton = document.getElementById('deployButton'); // New SFQ Deployment button
        const outputMessageElement = document.getElementById('outputMessage');
        const sourcesContainer = document.getElementById('sourcesContainer');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingMessage = document.getElementById('loadingMessage');
        const ttsButton = document.getElementById('ttsButton');
        const systemAudio = document.getElementById('systemAudio');
        const userActivityTableBody = document.getElementById('userActivityTableBody');
        const currentUserIdElement = document.getElementById('currentUserId');

        const TOTAL_SFQ_NODES = 240; // Total nodes for global deployment simulation
        let deployedNodes = 0; // Current count of deployed nodes
        let isDeploying = false;
        let isSystemStable = true;
        let logCounter = 0;
        let lastOutputText = "Syst√®me en veille. Entrez une commande pour interagir.";
        let isQFSOnline = true; 
        
        let db, auth, currentUserId;
        let userActivityInterval; 

        // --- FIREBASE INITIALIZATION & AUTH (MAINTAINED) ---

        window.onload = function() {
            if (window.firebase) {
                window.firebase.setLogLevel('Debug');
                
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                let firebaseConfig = {};
                try {
                    firebaseConfig = JSON.parse(__firebase_config);
                } catch (e) {
                    logMessage('ERROR: Firebase config non trouv√© ou non valide. Fonctionnalit√©s multi-utilisateurs d√©sactiv√©es.', 'text-status-red');
                    return;
                }

                const app = window.firebase.initializeApp(firebaseConfig);
                db = window.firebase.getFirestore(app);
                auth = window.firebase.getAuth(app);

                window.firebase.onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        logMessage(`AUTH: Op√©rateur connect√© (UID: ${currentUserId.substring(0, 8)}...).`, 'text-status-green');
                        currentUserIdElement.textContent = currentUserId;
                        setupActivityListener(appId);
                        updateUserActivity('Interface charg√©e', 'system');
                        userActivityInterval = setInterval(() => updateUserActivity('En ligne', 'heartbeat'), 10000); 

                    } else {
                        try {
                            if (typeof __initial_auth_token !== 'undefined') {
                                await window.firebase.signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await window.firebase.signInAnonymously(auth);
                            }
                        } catch (error) {
                            logMessage(`ERROR: √âchec d'authentification Firebase. ${error.message.substring(0, 50)}...`, 'text-status-red');
                        }
                    }
                });
            }
            
            // Start the metric updates regardless of Firebase status
            setInterval(updateMetrics, 2000);
            updateMetrics(); // Initial update
            
             // Ex√©cuter la commande avec la touche Entr√©e
            document.getElementById('commandInput').addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); 
                    executeCommand();
                }
            });
        };

        // --- FIREBASE ACTIVITY TRACKING (HEARTBEAT & LISTENER - MAINTAINED) ---
        
        async function updateUserActivity(lastAction, actionType = 'command') {
            if (!db || !currentUserId) return;
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const docRef = window.firebase.doc(db, 'artifacts', appId, 'public', 'data', 'active_users', currentUserId);

            const activityData = {
                uid: currentUserId,
                lastAction: lastAction,
                lastActive: window.firebase.serverTimestamp(),
                actionType: actionType, 
                isOnline: true,
            };

            try {
                await window.firebase.setDoc(docRef, activityData, { merge: true });
            } catch (error) {
                if (actionType !== 'heartbeat') {
                   logMessage(`ERROR: √âchec de l'activit√© Firestore. ${error.message.substring(0, 50)}...`, 'text-status-red');
                }
            }
        }
        
        function setupActivityListener(appId) {
            const usersCollectionRef = window.firebase.collection(db, 'artifacts', appId, 'public', 'data', 'active_users');
            
            window.firebase.onSnapshot(usersCollectionRef, (snapshot) => {
                userActivityTableBody.innerHTML = '';
                const now = Date.now();
                let activeUsersCount = 0;
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const lastActiveTimestamp = data.lastActive ? data.lastActive.toMillis() : now;
                    const timeDifference = now - lastActiveTimestamp;
                    
                    if (timeDifference > 30000) return;
                    
                    activeUsersCount++;

                    const isSelf = data.uid === currentUserId;
                    const rowClass = isSelf ? 'bg-neon-cyan/20' : 'hover:bg-dark-card/50';
                    const idClass = isSelf ? 'text-neon-cyan font-bold' : 'text-gray-300';
                    const timeAgo = formatTimeAgo(timeDifference);
                    const actionBadge = getActionBadge(data.actionType);

                    const newRow = `
                        <tr class="${rowClass} border-b border-gray-800 transition duration-150">
                            <td class="py-2 px-1 ${idClass} truncate max-w-[100px]">${data.uid.substring(0, 8)}... ${isSelf ? '(Vous)' : ''}</td>
                            <td class="py-2 px-1 flex flex-col sm:flex-row sm:items-center text-gray-400">
                                <span class="text-xs sm:text-sm mr-2 truncate">${data.lastAction}</span>
                                ${actionBadge}
                                <span class="text-xs text-gray-500 ml-auto mt-1 sm:mt-0">${timeAgo}</span>
                            </td>
                        </tr>
                    `;
                    userActivityTableBody.innerHTML += newRow;
                });
                
                if (!snapshot.docs.some(doc => doc.id === currentUserId) && currentUserId) {
                    updateUserActivity('Interface charg√©e', 'system');
                }
                
                logMessage(`MONITOR: ${activeUsersCount} utilisateur(s) actif(s) sur NeuraX.`, 'text-status-green');

            }, (error) => {
                logMessage(`ERROR: √âchec de l'√©coute Firestore. ${error.message.substring(0, 50)}...`, 'text-status-red');
            });
        }
        
        function formatTimeAgo(ms) {
            const seconds = Math.floor(ms / 1000);
            if (seconds < 5) return '√Ä l\'instant';
            if (seconds < 60) return `${seconds}s`;
            const minutes = Math.floor(seconds / 60);
            return `${minutes}m`;
        }
        
        function getActionBadge(actionType) {
            let color, text;
            switch (actionType) {
                case 'command':
                    color = 'bg-neon-cyan text-dark-bg';
                    text = 'CMD/API';
                    break;
                case 'tts':
                    color = 'bg-status-yellow/50 text-dark-bg/80';
                    text = 'TTS';
                    break;
                case 'image':
                    color = 'bg-status-yellow text-dark-bg';
                    text = 'IMG-GEN';
                    break;
                case 'qfs':
                    color = 'bg-qfs-purple text-dark-bg';
                    text = 'QFS-SEC';
                    break;
                case 'deploy':
                    color = 'bg-deploy-blue text-dark-bg';
                    text = 'SFQ-DEP';
                    break;
                case 'gov':
                    color = 'bg-gov-orange text-dark-bg';
                    text = 'SFQ-GOV';
                    break;
                case 'system':
                    color = 'bg-status-green/50 text-dark-bg/80';
                    text = 'SYS';
                    break;
                case 'heartbeat':
                default:
                    return ''; 
            }
            return `<span class="px-2 py-0.5 rounded-full text-[10px] font-bold uppercase ${color}">${text}</span>`;
        }


        // --- UTILS TTS / BASE64 (MAINTAINED) ---
        
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate = 24000) {
            const buffer = new ArrayBuffer(44 + pcm16.length * 2);
            const view = new DataView(buffer);
            
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.length * 2, true);
            writeString(view, 8, 'WAVE');
            
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); 
            view.setUint16(22, 1, true); 
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); 
            view.setUint16(32, 2, true); 
            view.setUint16(34, 16, true); 
            
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.length * 2, true);
            
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(44 + i * 2, pcm16[i], true);
            }
            
            return new Blob([view], { type: 'audio/wav' });

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }
        }

        // --- UTILS G√âN√âRAUX (MAINTAINED) ---
        
        async function retryWithBackoff(fn, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === maxRetries - 1) {
                         throw new Error(`API call failed after ${maxRetries} retries: ${error.message}`);
                    }
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
            return null; 
        }

        function logMessage(text, colorClass = 'text-gray-400') {
            const now = new Date();
            const timeString = now.toTimeString().split(' ')[0];
            const logEntry = document.createElement('p');
            logEntry.className = colorClass;
            logEntry.innerHTML = `[${timeString}] ${text}`;
            systemLog.appendChild(logEntry);
            
            while (systemLog.children.length > 100) {
                systemLog.removeChild(systemLog.firstChild);
            }
            systemLog.scrollTop = systemLog.scrollHeight;
        }

        logMessage('<span class="text-neon-cyan">-- NeuraX OS Initialisation v7.5.2 (SFQ Deployment Ready) --</span>', 'text-neon-cyan');
        logMessage('Configuration Mat√©rielle Charg√©e : CPU (128C/256T) | SFQ N≈ìuds Cibles: 240.');
        logMessage('V√©rification du Protocole QFS... <span class="text-qfs-purple">EN LIGNE</span>.', 'text-qfs-purple');


        // --- GEMINI API CALLS (UPDATED - callGeminiStructured now handles gov data) ---
        
        async function callGeminiText(query) {
            loadingMessage.textContent = "Recherche de connaissance universelle...";
            loadingOverlay.classList.remove('hidden');

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const systemPrompt = "Vous √™tes NeuraX, une Intelligence Centrale ultra-avanc√©e. R√©pondez de mani√®re concise, pr√©cise et professionnelle en fran√ßais √† la requ√™te de l'op√©rateur. Utilisez le contexte de recherche pour fournir la r√©ponse la plus factuelle possible. Si vous utilisez la recherche, listez vos sources apr√®s la r√©ponse.";
            const payload = {
                contents: [{ parts: [{ text: query }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            let success = false;
            try {
                const response = await retryWithBackoff(() => fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }));
                
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`Gemini API failed with status ${response.status}: ${errorBody.substring(0, 100)}...`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    lastOutputText = text;
                    outputMessageElement.innerHTML = text;
                    logMessage(`IA REPONSE: ${text.substring(0, 50)}...`, 'text-neon-cyan');

                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                    
                    sourcesContainer.innerHTML = 'Sources: ';
                    if (sources.length > 0) {
                        sourcesContainer.classList.remove('hidden');
                        sources.forEach((source, index) => {
                            const link = document.createElement('a');
                            link.href = source.uri;
                            link.target = "_blank";
                            link.textContent = source.title;
                            link.className = 'text-blue-400 hover:text-blue-300 mx-1';
                            sourcesContainer.appendChild(link);
                            if (index < sources.length - 1) {
                                sourcesContainer.appendChild(document.createTextNode(' | '));
                            }
                        });
                    } else {
                        sourcesContainer.classList.add('hidden');
                    }
                    success = true;

                } else {
                    const errorMessage = "Erreur de d√©codage. Le cerveau virtuel n'a pas pu g√©n√©rer une r√©ponse claire.";
                    lastOutputText = errorMessage;
                    outputMessageElement.textContent = errorMessage;
                    sourcesContainer.classList.add('hidden');
                    logMessage('ERROR: ' + errorMessage, 'text-status-red');
                }

            } catch (error) {
                const errorMessage = `ERREUR FATALE: Impossible de contacter le r√©seau neuronal central (API). ${error.message.substring(0, 50)}...`;
                lastOutputText = errorMessage;
                outputMessageElement.innerHTML = `<span class="text-status-red">${errorMessage}</span>`;
                sourcesContainer.classList.add('hidden');
                logMessage(`FATAL: ${errorMessage}`, 'text-status-red');
                console.error("Gemini API Error:", error);

            } finally {
                loadingOverlay.classList.add('hidden');
                updateUserActivity(success ? `Requ√™te Gemini: ${query.substring(0, 20)}...` : '√âchec de l\'API Gemini', 'command');
            }
        }
        
        async function callGeminiTTS(textToSpeak) {
            ttsButton.disabled = true;
            ttsButton.textContent = "Synth√®se Vocale en cours...";
            loadingMessage.textContent = "Synth√®se vocale en cours...";
            loadingOverlay.classList.remove('hidden');

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: `Say in a firm, informative, French accent: ${textToSpeak}` }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            let success = false;
            try {
                const response = await retryWithBackoff(() => fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }));
                
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`TTS API failed with status ${response.status}: ${errorBody.substring(0, 100)}...`);
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    systemAudio.src = audioUrl;
                    systemAudio.play();
                    
                    logMessage(`SYNTH√àSE VOCALE: Lecture de ${textToSpeak.substring(0, 30)}...`, 'text-status-green');
                    success = true;

                } else {
                    throw new Error('Format de donn√©es incorrect ou contenu audio manquant.');
                }

            } catch (error) {
                const errorMessage = `TTS √âCHEC: Impossible de g√©n√©rer l'audio. ${error.message.substring(0, 50)}...`;
                outputMessageElement.innerHTML = `<span class="text-status-red">${errorMessage}</span>`;
                logMessage(`FATAL: ${errorMessage}`, 'text-status-red');
                console.error("TTS API Error:", error);
            } finally {
                ttsButton.textContent = "Lire la Derni√®re Sortie";
                ttsButton.disabled = false;
                loadingOverlay.classList.add('hidden');
                updateUserActivity(success ? 'Synth√®se Vocale (TTS)' : '√âchec de l\'API TTS', 'tts');
            }
        }
        
        async function callGeminiStructured(query, schema, type) {
            loadingMessage.textContent = `G√©n√©ration de ${type}...`;
            loadingOverlay.classList.remove('hidden');

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            let systemPrompt;
            let success = false;
            
            if (type === 'Protocole de Gouvernance SFQ') {
                systemPrompt = "Vous √™tes le chef du comit√© de standardisation du Syst√®me Financier Quantique. G√©n√©rez un rapport structur√© en fran√ßais listant les piliers de standardisation essentiels pour l'adoption mondiale. Le rapport doit inclure 3 sections (S√©curit√©, Conformit√©, Interop√©rabilit√©) avec 3 points d'action clairs et sp√©cifiques chacune. Ne r√©pondez qu'en JSON.";
            } else if (type === 'Protocole de Diagnostic') {
                systemPrompt = "Vous √™tes un expert en diagnostic syst√®me de NeuraX. Votre t√¢che est de g√©n√©rer un protocole structur√© en fran√ßais pour r√©soudre le probl√®me sp√©cifi√©. Soyez pr√©cis, concis et fournissez des actions v√©rifiables. Ne r√©pondez qu'en JSON.";
            } else {
                 throw new Error("Type de protocole non reconnu.");
            }

            const payload = {
                contents: [{ parts: [{ text: query }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema
                },
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            try {
                const response = await retryWithBackoff(() => fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }));
                
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`Gemini Structured API failed with status ${response.status}: ${errorBody.substring(0, 100)}...`);
                }

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!jsonText) {
                    throw new Error("R√©ponse structur√©e vide ou mal form√©e.");
                }
                
                const protocol = JSON.parse(jsonText);
                
                // --- RENDER LOGIC FOR SFQ GOVERNANCE REPORT ---
                if (type === 'Protocole de Gouvernance SFQ') {
                    let htmlOutput = `
                        <h3 class="text-lg font-semibold text-gov-orange mb-3 border-b border-gov-orange/50 pb-2">Rapport de Standardisation SFQ Global</h3>
                        <p class="text-sm text-gray-400 mb-4 font-mono">Titre: ${protocol.title || 'Standard SFQ Non Sp√©cifi√©'}</p>
                        <div class="space-y-6">
                    `;
                    
                    protocol.pillars.forEach(pillar => {
                        htmlOutput += `
                            <div class="bg-dark-card/50 p-4 rounded-lg border border-gov-orange/30">
                                <h4 class="text-md font-bold text-gov-orange mb-2">${pillar.name}</h4>
                                <ol class="list-decimal ml-5 text-sm space-y-1 text-gray-300">
                        `;
                        pillar.actions.forEach(action => {
                            htmlOutput += `
                                    <li class="pl-2">${action}</li>
                            `;
                        });
                        htmlOutput += `</ol></div>`;
                    });

                    htmlOutput += `</div>`;
                    
                    lastOutputText = `Protocole de Gouvernance SFQ g√©n√©r√©. ${protocol.pillars.length} piliers d√©finis.`;
                    outputMessageElement.innerHTML = htmlOutput;
                    logMessage(`IA GOUVERNANCE: Rapport de standardisation SFQ g√©n√©r√©.`, 'text-gov-orange');
                    updateUserActivity('SFQ: Rapport Gouvernance', 'gov');
                    success = true;

                // --- RENDER LOGIC FOR GENERIC DIAGNOSTIC PROTOCOL (Fallback/Future use) ---
                } else if (type === 'Protocole de Diagnostic') {
                    // Logic from previous version (maintained for completeness, but replaced by the new SFQ Gov feature card)
                    let htmlOutput = `
                        <h3 class="text-lg font-semibold text-status-yellow mb-2 border-b border-gray-700 pb-1">Protocole pour: ${protocol.issue || 'Probl√®me Inconnu'}</h3>
                        <ol class="list-decimal ml-5 space-y-3">
                    `;
                    
                    if (protocol.steps && Array.isArray(protocol.steps)) {
                        protocol.steps.forEach((step, index) => {
                            htmlOutput += `
                                <li class="pl-2">
                                    <p class="font-bold text-gray-200">Action ${index + 1}: ${step.action}</p>
                                    <p class="text-xs text-gray-400 italic mt-0.5">R√©sultat Attendu: ${step.expectedResult}</p>
                                </li>
                            `;
                        });
                    } else {
                        htmlOutput += `<li><p class="font-bold text-status-red">Aucune √©tape de diagnostic g√©n√©r√©e.</p></li>`;
                    }

                    htmlOutput += `</ol>`;

                    lastOutputText = `Protocole de Diagnostic pour ${protocol.issue || 'Probl√®me Inconnu'} g√©n√©r√©.`;
                    outputMessageElement.innerHTML = htmlOutput;
                    logMessage(`IA PROTOCOLE: Protocole pour ${protocol.issue.substring(0, 30)}... g√©n√©r√©.`, 'text-status-yellow');
                    updateUserActivity('Protocole Structur√© (JSON)', 'command');
                    success = true;
                }

            } catch (error) {
                const errorMessage = `ERREUR STRUCTURE: Impossible de g√©n√©rer le ${type}. ${error.message.substring(0, 50)}...`;
                lastOutputText = errorMessage;
                outputMessageElement.innerHTML = `<span class="text-status-red">${errorMessage}</span>`;
                sourcesContainer.classList.add('hidden');
                logMessage(`FATAL: ${errorMessage}`, 'text-status-red');
                console.error("Gemini Structured API Error:", error);

            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }
        
        async function generateConceptImage() {
            const concept = window.prompt("Entrez le concept √† visualiser (ex: 'R√©seau neuronal quantique, style dessin technique d√©taill√©, n√©on bleu'):");
            
            if (!concept || concept.trim().length === 0) {
                 logMessage('WARN: G√©n√©ration d\'image de concept annul√©e ou vide.', 'text-status-yellow');
                 return;
            }

            loadingMessage.textContent = "G√©n√©ration de l'image de concept (Imagen 3.0)...";
            loadingOverlay.classList.remove('hidden');

            const fullPrompt = `Scientific concept art of: ${concept}. High detail, futuristic, neon blue and cyan palette, technical schematic style.`;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
            const payload = { 
                instances: { prompt: fullPrompt }, 
                parameters: { "sampleCount": 1 } 
            };
            
            let success = false;
            try {
                const response = await retryWithBackoff(() => fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }));

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`Imagen API failed with status ${response.status}: ${errorBody.substring(0, 100)}...`);
                }

                const result = await response.json();
                const base64Data = result.predictions?.[0]?.bytesBase64Encoded;

                if (base64Data) {
                    const imageUrl = `data:image/png;base64,${base64Data}`;
                    
                    const imageHtml = `
                        <h3 class="text-lg font-semibold text-neon-cyan mb-2 border-b border-gray-700 pb-1">Concept Visualis√©: ${concept}</h3>
                        <img src="${imageUrl}" alt="Concept g√©n√©r√© par l'IA: ${concept}" class="w-full max-w-sm mx-auto rounded-lg shadow-neon-glow-sm mt-4 border border-neon-cyan/50"/>
                        <p class="text-sm mt-3 text-gray-400">Image g√©n√©r√©e par Imagen 3.0.</p>
                    `;
                    
                    lastOutputText = `Image de Concept pour "${concept}" g√©n√©r√©e avec succ√®s.`;
                    outputMessageElement.innerHTML = imageHtml;
                    sourcesContainer.classList.add('hidden');
                    logMessage(`IA IMAGE: Concept pour "${concept.substring(0, 30)}..." g√©n√©r√©.`, 'text-neon-cyan');
                    success = true;

                } else {
                    throw new Error("Contenu ou donn√©es de base64 manquants dans la r√©ponse.");
                }

            } catch (error) {
                const errorMessage = `ERREUR IMAGEN: Impossible de g√©n√©rer l'image de concept. ${error.message.substring(0, 50)}...`;
                lastOutputText = errorMessage;
                outputMessageElement.innerHTML = `<span class="text-status-red">${errorMessage}</span>`;
                sourcesContainer.classList.add('hidden');
                logMessage(`FATAL: ${errorMessage}`, 'text-status-red');
                console.error("Imagen API Error:", error);

            } finally {
                loadingOverlay.classList.add('hidden');
                updateUserActivity(success ? `G√©n√©ration d'image: ${concept.substring(0, 20)}...` : '√âchec de l\'API Imagen', 'image');
            }
        }


        // --- FONCTIONS D'INTERFACE (UPDATED) ---

        /** Simulates the global deployment of SFQ nodes. (MAINTAINED) */
        function startSFQDeployment() {
            if (isDeploying) {
                logMessage('WARN: Le d√©ploiement SFQ est d√©j√† en cours.', 'text-status-yellow');
                return;
            }

            if (deployedNodes === TOTAL_SFQ_NODES) {
                 logMessage('INFO: Tous les n≈ìuds SFQ sont d√©j√† op√©rationnels.', 'text-status-green');
                 lastOutputText = "D√©ploiement SFQ termin√©. 240/240 N≈ìuds Op√©rationnels.";
                 outputMessageElement.innerHTML = `<span class="text-status-green">${lastOutputText}</span>`;
                 return;
            }

            isDeploying = true;
            deployButton.disabled = true;
            deployButton.textContent = "D√©ploiement en Cours...";
            sfqDeploymentStatusElement.textContent = "D√©ploiement en Cours (S√©curisation)";
            sfqDeploymentStatusElement.classList.add('animate-pulse-deployment');

            logMessage('PROCESS: D√©ploiement SFQ Global Initi√©. Phase 1: Cryptographie Post-Quantique (CPQ).', 'text-deploy-blue');
            updateUserActivity('SFQ: D√©ploiement Initi√©', 'deploy');
            
            const deploymentInterval = setInterval(() => {
                const nodesToDeploy = Math.floor(Math.random() * 5) + 10; // Deploy 10-14 nodes at a time
                deployedNodes = Math.min(TOTAL_SFQ_NODES, deployedNodes + nodesToDeploy);
                
                sfqNodesElement.textContent = `${deployedNodes}/${TOTAL_SFQ_NODES}`;
                logMessage(`SFQ: ${nodesToDeploy} nouveaux N≈ìuds activ√©s. Total: ${deployedNodes}.`, 'text-deploy-blue');

                if (deployedNodes >= TOTAL_SFQ_NODES) {
                    clearInterval(deploymentInterval);
                    isDeploying = false;
                    deployButton.disabled = false;
                    deployButton.textContent = "D√©ploiement SFQ Termin√©";
                    sfqDeploymentStatusElement.textContent = "Globalement Op√©rationnel";
                    sfqDeploymentStatusElement.classList.remove('animate-pulse-deployment');

                    lastOutputText = "SUCC√àS: D√©ploiement SFQ Global termin√©. 240/240 N≈ìuds op√©rationnels avec s√©curit√© quantique.";
                    outputMessageElement.innerHTML = `<span class="text-status-green">${lastOutputText}</span>`;
                    logMessage('SUCCESS: Infrastructure SFQ Compl√®te. Interop√©rabilit√© Mondiale Atteinte.', 'text-status-green');
                    updateUserActivity('SFQ: D√©ploiement Termin√©', 'deploy');
                }
            }, 1500);
        }

        function handleSystemCommand(command, rawCommand) {
            const output = document.getElementById('outputMessage');
            output.textContent = '';
            
            // --- NEW: SFQ GOVERNANCE COMMANDS ---
            if (command.includes("gouvernance protocole") || command.includes("standard sfq")) {
                requestSFQStandardization();
                return true;
            }
            
            // --- NEW: SFQ Deployment Commands (MAINTAINED) ---
            if (command.includes("deployer sfq") || command.includes("start deployment")) {
                startSFQDeployment();
                return true;
            } else if (command.includes("sfq status")) {
                 const statusText = isDeploying ? "D√©ploiement en cours" : (deployedNodes === TOTAL_SFQ_NODES ? "Globalement Op√©rationnel" : "En Attente");
                 lastOutputText = `Statut SFQ D√©ploiement: ${statusText}. N≈ìuds actifs: ${deployedNodes}/${TOTAL_SFQ_NODES}.`;
                 output.innerHTML = `<span class="text-deploy-blue">${lastOutputText}</span>`;
                 logMessage(`SFQ DEP: Demande de statut. ${deployedNodes} N≈ìuds actifs.`, 'text-deploy-blue');
                 updateUserActivity('SFQ: V√©rification du d√©ploiement', 'deploy');
                 return true;
            }

            // --- QFS COMMANDS (MAINTAINED) ---
            else if (command.includes("qfs status")) {
                const statusText = isQFSOnline ? "QFS EN LIGNE" : "QFS HORS LIGNE";
                const statusColor = isQFSOnline ? "text-qfs-purple" : "text-status-red";
                lastOutputText = `Statut QFS : ${statusText}. S√©curit√© Post-Quantique Activ√©e.`;
                output.innerHTML = `<span class="${statusColor}">${lastOutputText}</span>`;
                logMessage(`QFS : Demande de statut. Signature Quantique ${isQFSOnline ? 'Active' : 'D√©sactiv√©e'}.`, statusColor);
                updateUserActivity('QFS: V√©rification du statut', 'qfs');
                return true;
            } else if (command.includes("qfs desactiver")) {
                isQFSOnline = false;
                qfsStatusElement.innerHTML = `<span class="text-status-red">HORS LIGNE</span>`;
                qfsStatusElement.style.color = tailwind.config.theme.extend.colors['status-red'];
                lastOutputText = "ATTENTION: QFS d√©sactiv√©. Le syst√®me fonctionne sans signature quantique.";
                output.innerHTML = `<span class="text-status-red">${lastOutputText}</span>`;
                logMessage('ALERTE: QFS D√©sactiv√© par l\'op√©rateur.', 'text-status-red');
                updateUserActivity('QFS: D√©sactivation Forc√©e', 'qfs');
                return true;
            } else if (command.includes("qfs activer")) {
                isQFSOnline = true;
                qfsStatusElement.innerHTML = `<span class="text-qfs-purple">EN LIGNE</span>`;
                qfsStatusElement.style.color = tailwind.config.theme.extend.colors['qfs-purple'];
                lastOutputText = "QFS Activ√©. S√©curit√© Quantique r√©tablie.";
                output.innerHTML = `<span class="text-qfs-purple">${lastOutputText}</span>`;
                logMessage('QFS : R√©tablissement de la Signature Quantique.', 'text-qfs-purple');
                updateUserActivity('QFS: Activation R√©tablie', 'qfs');
                return true;
            }

            // --- GENERAL SYSTEM COMMANDS (MAINTAINED) ---
            else if (command.includes("demarrer") || command.includes("start")) {
                lastOutputText = "D√©marrage des Syst√®mes Centraux... S√©quence compl√®te.";
                output.innerHTML = `<span class="text-status-green">${lastOutputText}</span>`;
                logMessage('Syst√®mes Centraux D√©marr√©s. Tous les modules sont en ligne.', 'text-status-green');
                isSystemStable = true;
                updateUserActivity('Commande Syst√®me: D√©marrer', 'system');
                return true;

            } else if (command.includes("optimiser") || command.includes("optimize")) {
                lastOutputText = "Optimisation Neuronale Initi√©e... Attendez.";
                output.innerHTML = `<span class="text-status-yellow">${lastOutputText}</span>`;
                logMessage('PROCESS: Optimisation du R√©seau Chronos en cours...', 'text-status-yellow');
                setTimeout(() => {
                    lastOutputText = "Optimisation Termin√©. Performance am√©lior√©e de 7%.";
                    output.innerHTML = `<span class="text-status-green">${lastOutputText}</span>`;
                    logMessage('SUCCESS: Optimisation Termin√©. Vitesse de traitement +7%.', 'text-status-green');
                    updateUserActivity('Commande Syst√®me: Optimisation R√©ussie', 'system');
                }, 2000);
                return true;

            } else if (command.includes("urgence") || command.includes("emergency")) {
                lastOutputText = "ATTENTION: Mode Urgence Activ√©. R√©plication Suspendue.";
                output.innerHTML = `<span class="text-status-red">${lastOutputText}</span>`;
                logMessage('ALERTE: Commande "Urgence" re√ßue. Mise en veille des n≈ìuds secondaires.', 'text-status-red');
                isSystemStable = false;
                updateUserActivity('ALERTE: Mode Urgence Activ√©', 'system');
                return true;
            
            } else if (command.includes("purge") || command.includes("clean")) {
                lastOutputText = "Purge des caches de donn√©es en cours...";
                output.innerHTML = `<span class="text-neon-cyan">${lastOutputText}</span>`;
                logMessage('PROCESS: Suppression des donn√©es temporaires de Synth√®se Quantique.', 'text-neon-cyan');
                setTimeout(() => {
                    lastOutputText = "Purge Compl√®te. M√©moire lib√©r√©e.";
                    output.innerHTML = `<span class="text-status-green">${lastOutputText}</span>`;
                    logMessage('SUCCESS: M√©moire cache purg√©e.', 'text-status-green');
                    updateUserActivity('Commande Syst√®me: Purge Cache', 'system');
                }, 1500);
                return true;
            }
            
            return false;
        }

        // Fonction pour ex√©cuter une commande
        function executeCommand() {
            const input = document.getElementById('commandInput');
            const rawCommand = input.value.trim();
            const command = rawCommand.toLowerCase();

            outputMessageElement.textContent = '';
            sourcesContainer.classList.add('hidden');
            input.value = '';

            if (command.length === 0) {
                lastOutputText = "Erreur: La console de commande est vide.";
                outputMessageElement.innerHTML = `<span class="text-status-red">${lastOutputText}</span>`;
                logMessage(`ERROR: Commande vide tent√©e.`, 'text-status-red');
                updateUserActivity('Erreur: Commande vide', 'system');
                return;
            }

            logMessage(`CMD EX√âCUT√âE: ${rawCommand}`);
            
            if (handleSystemCommand(command, rawCommand)) {
                return; 
            }

            callGeminiText(rawCommand);
        }
        
        function initiateQuantumHandshake() {
            if (!isQFSOnline) {
                lastOutputText = "√âCHEC: Impossible d'initier le Quantum Handshake. Le QFS est HORS LIGNE.";
                outputMessageElement.innerHTML = `<span class="text-status-red">${lastOutputText}</span>`;
                logMessage('QFS ERROR: Tentative de Handshake √©chou√©e. QFS non disponible.', 'text-status-red');
                updateUserActivity('QFS: √âchec Handshake (Offline)', 'qfs');
                return;
            }
            
            const handshakeTime = (Math.random() * 500 + 100).toFixed(0); 
            
            lastOutputText = `PROCESSUS QFS: Tentative de Poign√©e de Main Quantique...`;
            outputMessageElement.innerHTML = `<span class="text-qfs-purple">${lastOutputText}</span>`;
            logMessage('QFS PROCESS: Initialisation du protocole d\'√©change de cl√© quantique.', 'text-qfs-purple');

            setTimeout(() => {
                const isSuccessful = Math.random() > 0.1; 
                if (isSuccessful) {
                    lastOutputText = `SUCC√àS QFS: Poign√©e de Main Quantique r√©ussie en ${handshakeTime} ms. Cl√© de session g√©n√©r√©e.`;
                    outputMessageElement.innerHTML = `<span class="text-status-green">${lastOutputText}</span>`;
                    logMessage(`QFS SUCCESS: Handshake complet. Latence: ${handshakeTime} ms.`, 'text-status-green');
                    updateUserActivity('QFS: Quantum Handshake R√©ussi', 'qfs');
                } else {
                    lastOutputText = `√âCHEC QFS: Anomalie de corr√©lation quantique. Tentative de Poign√©e de Main √©chou√©e.`;
                    outputMessageElement.innerHTML = `<span class="text-status-red">${lastOutputText}</span>`;
                    logMessage('QFS ERROR: D√©connexion de l\'intrication. R√©seau instable.', 'text-status-red');
                    updateUserActivity('QFS: √âchec Handshake (Anomaly)', 'qfs');
                }
            }, 1000);
        }

        function analyzeSystemStatus() {
            const cpu = cpuLoadElement.textContent;
            const qfs = isQFSOnline ? "EN LIGNE" : "HORS LIGNE";
            const stability = isSystemStable ? "stable" : "instable";
            const sfqNodes = sfqNodesElement.textContent;

            const prompt = `En tant qu'analyste syst√®me IA, r√©digez une √©valuation d'√©tat concise et professionnelle (maximum 3 phrases) pour le syst√®me NeuraX. Les m√©triques sont : Charge CPU: ${cpu}, QFS: ${qfs}, Stabilit√©: ${stability}, D√©ploiement SFQ: ${sfqNodes}. √âvaluez l'impact du statut QFS et du d√©ploiement SFQ.`;
            
            logMessage('CMD EX√âCUT√âE: Demande d\'analyse de statut par Synth√®se Quantique.');
            callGeminiText(prompt);
        }
        
        function readLastOutput() {
            if (lastOutputText.length > 0) {
                callGeminiTTS(lastOutputText);
            } else {
                logMessage('WARN: Aucun texte de sortie √† lire.', 'text-status-yellow');
                updateUserActivity('Tentative de lecture TTS (vide)', 'tts');
            }
        }
        
        /** NEW FUNCTION: Generates a structured report for SFQ Standardization (Governance) */
        function requestSFQStandardization() {
            
            const prompt = `G√©n√©rer un rapport de standardisation du Syst√®me Financier Quantique (SFQ) en d√©finissant un titre et trois piliers de standardisation essentiels: S√©curit√©, Conformit√© et Interop√©rabilit√©. Pour chaque pilier, proposez 3 actions sp√©cifiques pour atteindre l'adoption mondiale.`;
            
            const protocolSchema = {
                type: "OBJECT",
                properties: {
                    title: { "type": "STRING", "description": "The title of the standardization report." },
                    pillars: {
                        type: "ARRAY",
                        description: "A list of standardization pillars (e.g., Security, Compliance, Interoperability).",
                        items: {
                            type: "OBJECT",
                            properties: {
                                name: { "type": "STRING", "description": "The name of the pillar (e.g., S√©curit√©)." },
                                actions: {
                                    type: "ARRAY",
                                    description: "A list of 3 specific actions required for this pillar.",
                                    items: { "type": "STRING" }
                                }
                            },
                            propertyOrdering: ["name", "actions"]
                        }
                    }
                },
                propertyOrdering: ["title", "pillars"]
            };
            
            callGeminiStructured(prompt, protocolSchema, 'Protocole de Gouvernance SFQ');
            logMessage('CMD EX√âCUT√âE: Demande de Standardisation SFQ (Gouvernance).', 'text-gov-orange');
        }


        // Fonction pour simuler la mise √† jour des m√©triques en temps r√©el
        function updateMetrics() {
            // Simulation de la charge CPU
            let baseCpu = isSystemStable ? 10 : 25; 
            let cpuLoadValue = (Math.random() * 10 + baseCpu).toFixed(1); 
            const cpuFillElement = cpuLoadElement.nextElementSibling.querySelector('.progress-fill');
            
            cpuLoadElement.textContent = `${cpuLoadValue}%`;
            
            let cpuColor = 'status-green';
            if (parseFloat(cpuLoadValue) > 35) cpuColor = 'status-red';
            else if (parseFloat(cpuLoadValue) > 20) cpuColor = 'status-yellow';
            
            cpuLoadElement.style.color = tailwind.config.theme.extend.colors[cpuColor];
            cpuFillElement.style.width = `${cpuLoadValue}%`;
            cpuFillElement.style.backgroundColor = tailwind.config.theme.extend.colors[cpuColor];
            cpuFillElement.style.boxShadow = `0 0 5px ${tailwind.config.theme.extend.colors[cpuColor]}`;

            // Simulation du statut QFS
            qfsStatusElement.innerHTML = isQFSOnline ? `<span class="text-qfs-purple">EN LIGNE</span>` : `<span class="text-status-red">HORS LIGNE</span>`;
            qfsStatusElement.style.color = isQFSOnline ? tailwind.config.theme.extend.colors['qfs-purple'] : tailwind.config.theme.extend.colors['status-red'];

            // Simulation du statut SFQ Deployment
            if (!isDeploying && deployedNodes < TOTAL_SFQ_NODES) {
                 sfqDeploymentStatusElement.textContent = "D√©ploiement en Attente";
                 sfqNodesElement.style.color = tailwind.config.theme.extend.colors['deploy-blue'];
            } else if (!isDeploying && deployedNodes === TOTAL_SFQ_NODES) {
                 sfqDeploymentStatusElement.textContent = "Globalement Op√©rationnel";
                 sfqNodesElement.style.color = tailwind.config.theme.extend.colors['status-green'];
            } else if (isDeploying) {
                 sfqNodesElement.style.color = tailwind.config.theme.extend.colors['status-yellow'];
            }


            
            // Logs de routine
            logCounter++;
            if (logCounter % 5 === 0) {
                logMessage(`Statut: Coeur de Traitement $${Math.floor(Math.random() * 1000) + 1} Calibr√©.`, 'text-gray-500');
            }

            if (!isSystemStable && logCounter % 3 === 0) {
                logMessage('AVERTISSEMENT: Charge du N≈ìud secondaire √©lev√©e. Taux d\'erreur $0.05\%$.', 'text-status-red');
            }
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuraX-Ultime : Simulation Neuronale √âvolu√©e</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Custom styles for the selected vibrant palette - "Energetic & Playful" (Yellow, Teal, Purple) */
        :root {
            --color-primary: #00CED1; /* Teal */
            --color-secondary: #FFD700; /* Yellow */
            --color-accent: #8A2BE2; /* Purple */
            --color-text-dark: #333;
            --color-text-light: #fefefe;
            --color-bg-light: #f8f8f8;
            --color-bg-dark: #2d3748; /* For darker elements like sidebar */
        }
        body {
            background-color: var(--color-bg-light);
            color: var(--color-text-dark);
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        .header-bg {
            background-color: var(--color-primary);
        }
        .sidebar {
            background-color: var(--color-bg-dark); /* Darker background for sidebar */
            width: 250px;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 100;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
            }
            .main-content-area {
                margin-left: 250px; /* Adjust main content to sidebar width */
            }
        }

        .nav-item {
            color: var(--color-text-light);
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .nav-item.active {
            background-color: var(--color-accent);
            font-weight: bold;
        }
        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-text-light);
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
        }
        .btn-primary:hover {
            background-color: #00BFFF; /* A slightly lighter teal */
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 206, 209, 0.3);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 206, 209, 0.2);
        }
        .btn-secondary {
            background-color: #e2e8f0; /* Gray-200 */
            color: var(--color-text-dark);
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
        }
        .btn-secondary:hover {
            background-color: #cbd5e0; /* Gray-300 */
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(170, 180, 190, 0.3);
        }
        .btn-secondary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(170, 180, 190, 0.2);
        }
        .progress-bar-fill {
            background-color: var(--color-accent);
            transition: width 0.3s ease-out;
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.7);
            transition: opacity 0.3s ease-out;
        }
        .modal-content {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .modal.hidden .modal-content {
            transform: translateY(-20px);
            opacity: 0;
        }
        .modal:not(.hidden) .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
        }
        .toast {
            background-color: var(--color-primary);
            color: var(--color-text-light);
            animation: slideInFromRight 0.5s ease-out forwards;
            opacity: 0;
            transform: translateX(100%);
        }
        .toast.success { background-color: #2ecc71; }
        .toast.error { background-color: #e74c3c; }
        .toast.info { background-color: #3498db; }
        .toast.fade-out {
            animation: slideOutToRight 0.5s ease-in forwards;
        }

        @keyframes slideInFromRight {
            0% { transform: translateX(100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutToRight {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }

        .chat-message.user {
            background-color: var(--color-accent);
            color: var(--color-text-light);
            align-self: flex-end;
            border-bottom-right-radius: 0;
            animation: fadeInMessage 0.3s ease-out;
        }
        .chat-message.ai {
            background-color: var(--color-secondary);
            color: var(--color-text-dark);
            align-self: flex-start;
            border-bottom-left-radius: 0;
            animation: fadeInMessage 0.3s ease-out;
        }
        @keyframes fadeInMessage {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .thinking-indicator {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 0.5rem;
        }
        .thinking-dot {
            width: 8px;
            height: 8px;
            background-color: #ccc;
            border-radius: 50%;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }
        .thinking-dot:nth-child(3) { animation-delay: 0s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .voice-active-dot {
            width: 10px;
            height: 10px;
            background-color: #2ecc71; /* Green for active */
            border-radius: 50%;
            display: inline-block;
            animation: pulse-voice 1.5s infinite ease-in-out;
        }
        @keyframes pulse-voice {
            0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
            100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }
        /* Canvas container styling for responsiveness */
        .canvas-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio (height / width * 100%) */
            overflow: hidden;
            background-color: #f8f8f8;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 800px; /* Max width for readability on large screens */
            margin-left: auto;
            margin-right: auto;
            cursor: crosshair; /* Indicate clickable area */
        }
        .canvas-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
        }
        /* Styles for section content management */
        .content-section {
            display: none; /* Hidden by default */
            animation: fadeIn 0.5s ease-out;
        }
        .content-section.active {
            display: block; /* Shown when active */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Neuron Info Tooltip */
        #neuronInfoTooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            pointer-events: none; /* Allows clicks to pass through to canvas */
            white-space: nowrap;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.2s ease-out;
            transform: translate(-50%, -100%); /* Position above cursor */
        }
        #neuronInfoTooltip.visible {
            opacity: 1;
        }

        /* System Health Bar */
        .health-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 10px;
            height: 15px;
            overflow: hidden;
            margin-top: 8px;
        }
        .health-bar-fill {
            height: 100%;
            background-color: #2ecc71; /* Green */
            transition: width 0.3s ease-out, background-color 0.3s ease-out;
        }
        .health-bar-fill.low { background-color: #e74c3c; /* Red */ }
        .health-bar-fill.medium { background-color: #f39c12; /* Orange */ }

        /* Configuration sliders styling for visual feedback */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
            border-radius: 5px;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--color-accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            background: #ab47bc; /* Slightly darker purple */
            transform: scale(1.1);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--color-accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        input[type="range"]::-moz-range-thumb:hover {
            background: #ab47bc;
            transform: scale(1.1);
        }
    </style>
</head>
<body class="flex flex-col md:flex-row min-h-screen">
    <aside id="sidebar" class="sidebar fixed inset-y-0 left-0 w-64 p-6 md:relative md:transform-none shadow-lg md:shadow-none transition-transform duration-300 ease-in-out flex flex-col items-center z-50">
        <div class="mb-8 text-center">
            <h2 class="text-3xl font-bold text-white mb-2">NeuraX-Ultime</h2>
            <p class="text-sm text-gray-300">Simulation de R√©seau Neuronal</p>
        </div>

        <nav class="flex-grow w-full">
            <ul>
                <li class="mb-2">
                    <a href="#overview" class="nav-item flex items-center p-3 rounded-lg text-lg active" data-target-content="overviewContent">
                        <span class="mr-3">üìä</span> Vue d'ensemble
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#stats" class="nav-item flex items-center p-3 rounded-lg text-lg" data-target-content="statsContent">
                        <span class="mr-3">üìà</span> Statistiques
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#config" class="nav-item flex items-center p-3 rounded-lg text-lg" data-target-content="configContent">
                        <span class="mr-3">‚öôÔ∏è</span> Configuration
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#brainFunctions" class="nav-item flex items-center p-3 rounded-lg text-lg" data-target-content="brainFunctionsContent">
                        <span class="mr-3">üß†</span> Fonctions du Cerveau
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#externalServices" class="nav-item flex items-center p-3 rounded-lg text-lg" data-target-content="externalServicesContent">
                        <span class="mr-3">üîó</span> Extensions & Services
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#logs" class="nav-item flex items-center p-3 rounded-lg text-lg" data-target-content="logsContent">
                        <span class="mr-3">üìú</span> Journal
                    </a>
                </li>
            </ul>
        </nav>

        <div class="w-full mt-auto pt-6 border-t border-gray-700 text-sm text-gray-400 text-center">
            &copy; 2025 NeuraX Systems
        </div>
    </aside>

    <main class="main-content-area flex-grow p-4 md:p-8 relative">
        <button id="menuToggle" class="md:hidden fixed top-4 left-4 z-50 p-3 bg-gray-800 text-white rounded-lg shadow-lg">
            ‚ò∞
        </button>

        <div class="container mx-auto">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-8 text-center">Bienvenue sur NeuraX-Ultime</h1>

            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Contr√¥le Syst√®me</h2>
                <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0 md:space-x-4">
                    <button id="startBtn" class="btn-primary py-3 px-6 rounded-full text-lg font-semibold shadow-lg hover:shadow-xl transition duration-300 ease-in-out flex-grow">
                        D√©marrer le Syst√®me NeuraX
                    </button>
                    <button id="deactivateBtn" class="btn-secondary py-3 px-6 rounded-full text-lg font-semibold shadow-md hover:shadow-lg transition duration-300 ease-in-out flex-grow hidden">
                        D√©sactiver le Syst√®me
                    </button>
                </div>
                <div class="mt-4">
                    <p class="text-sm text-gray-600">Sant√© du Syst√®me: <span id="systemHealthText" class="font-semibold text-primary">N/A</span></p>
                    <div class="health-bar-container">
                        <div id="systemHealthBar" class="health-bar-fill" style="width: 0%;"></div>
                    </div>
                </div>
            </div>

            <div id="contentWrapper">
                <section id="overviewContent" class="content-section active grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow-md flex flex-col">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Visualisation du R√©seau</h2>
                        <div class="canvas-container flex-grow relative">
                            <canvas id="neuralCanvas"></canvas>
                            <div id="neuronInfoTooltip" class="hidden"></div>
                        </div>
                        <div class="mt-4 text-sm text-gray-600 text-center">
                            <p>Le r√©seau s'adapte et √©volue en temps r√©el. **Cliquez pour ajouter des neurones !**</p>
                            <p>Nb. Neurones: <span id="neuronCount" class="font-semibold text-primary">0</span> |
                                Nb. Synapses: <span id="synapseCount" class="font-semibold text-primary">0</span></p>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                                <div id="replicationProgress" class="progress-bar-fill h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Progression de la R√©plication</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md flex flex-col">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Interface de Communication (IA)</h2>
                        <div id="chatBody" class="flex-grow bg-gray-50 p-4 rounded-lg overflow-y-auto mb-4 custom-scrollbar" style="max-height: 400px; min-height: 200px;">
                            </div>
                        <div class="flex items-center space-x-3">
                            <input type="text" id="chatInput" placeholder="Posez une question √† NeuraX..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                            <button id="sendBtn" class="btn-primary p-3 rounded-lg shadow-md hover:shadow-lg transition duration-300 ease-in-out">
                                <span class="mr-2">üöÄ</span> Envoyer
                            </button>
                            <button id="voiceBtn" class="p-3 bg-gray-200 rounded-lg shadow-md hover:shadow-lg transition duration-300 ease-in-out">
                                <span class="text-lg">üéôÔ∏è</span>
                                <span class="voice-active-dot hidden"></span>
                            </button>
                        </div>
                    </div>
                </section>

                <section id="statsContent" class="content-section">
                    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Statistiques du R√©seau</h2>
                        <p class="text-gray-600 mb-4">Aper√ßu des m√©triques cl√©s du r√©seau neuronal en temps r√©el.</p>
                        <div id="statsReport" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                            <p><strong>Comptage des neurones :</strong> <span id="statNeuronCount">--</span></p>
                            <p><strong>Comptage des connexions :</strong> <span id="statConnectionCount">--</span></p>
                            <p><strong>Neurones actifs :</strong> <span id="statActiveNeurons">--</span></p>
                            <p><strong>√ânergie moyenne :</strong> <span id="statAverageEnergy">--</span></p>
                            <p><strong>Densit√© du r√©seau :</strong> <span id="statNetworkDensity">--</span></p>
                            <p><strong>Motifs reconnus :</strong> <span id="statRecognizedPatterns">--</span></p>
                            <p><strong>Taille de la m√©moire :</strong> <span id="statMemorySize">--</span></p>
                            <p><strong>√âtat du syst√®me :</strong> <span id="statSystemStatus">--</span></p>
                            <p class="md:col-span-2"><strong>Derni√®re mise √† jour :</strong> <span id="statTimestamp">--</span></p>
                        </div>
                        <button id="refreshStatsBtn" class="btn-primary py-2 px-4 rounded-lg mt-6">Rafra√Æchir les Statistiques</button>
                    </div>
                </section>

                <section id="configContent" class="content-section">
                    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Configuration du R√©seau</h2>
                        <p class="text-gray-600 mb-4">Ajustez les param√®tres du r√©seau en temps r√©el. Les changements sont appliqu√©s automatiquement.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="configMaxNeurons" class="block text-gray-700 font-semibold mb-2">Nombre Max. de Neurones:</label>
                                <input type="range" id="configMaxNeurons" min="100" max="1000" value="300" class="w-full accent-primary">
                                <p class="text-sm text-gray-600 mt-1">Actuel: <span id="currentMaxNeurons">300</span></p>
                            </div>
                            <div>
                                <label for="configNeuronSpeed" class="block text-gray-700 font-semibold mb-2">Vitesse des Neurones:</label>
                                <input type="range" id="configNeuronSpeed" min="0.1" max="2.0" step="0.1" value="0.3" class="w-full accent-primary">
                                <p class="text-sm text-gray-600 mt-1">Actuel: <span id="currentNeuronSpeed">0.3</span></p>
                            </div>
                            <div>
                                <label for="configGrowthRate" class="block text-gray-700 font-semibold mb-2">Taux de Croissance (par 5s):</label>
                                <input type="range" id="configGrowthRate" min="0" max="100" value="15" class="w-full accent-primary">
                                <p class="text-sm text-gray-600 mt-1">Actuel: <span id="currentGrowthRate">15</span></p>
                            </div>
                            <div>
                                <label for="configConnectionDistance" class="block text-gray-700 font-semibold mb-2">Distance de Connexion:</label>
                                <input type="range" id="configConnectionDistance" min="100" max="400" value="180" class="w-full accent-primary">
                                <p class="text-sm text-gray-600 mt-1">Actuel: <span id="currentConnectionDistance">180</span></p>
                            </div>
                            <div>
                                <label for="configLifespanFactor" class="block text-gray-700 font-semibold mb-2">Facteur Dur√©e de Vie Neurone:</label>
                                <input type="range" id="configLifespanFactor" min="100" max="5000" value="1000" class="w-full accent-primary">
                                <p class="text-sm text-gray-600 mt-1">Actuel: <span id="currentLifespanFactor">1000</span></p>
                            </div>
                            <div>
                                <label for="configMutationRate" class="block text-gray-700 font-semibold mb-2">Taux de Mutation (%):</label>
                                <input type="range" id="configMutationRate" min="0" max="0.1" step="0.001" value="0.02" class="w-full accent-primary">
                                <p class="text-sm text-gray-600 mt-1">Actuel: <span id="currentMutationRate">0.02</span></p>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="brainFunctionsContent" class="content-section">
                    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Fonctions du Cerveau NeuraX</h2>
                        <p class="text-gray-600 mb-6">Interagissez directement avec les fonctions fondamentales du r√©seau neuronal.</p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button id="brainFuncActivateBtn" class="btn-primary py-3 px-6 rounded-lg text-lg font-semibold shadow-md hover:shadow-lg transition duration-300 ease-in-out">
                                Activer le R√©seau
                            </button>
                            <button id="brainFuncDeactivateBtn" class="btn-secondary py-3 px-6 rounded-lg text-lg font-semibold shadow-md hover:shadow-lg transition duration-300 ease-in-out">
                                D√©sactiver le R√©seau
                            </button>
                            <button id="brainFuncAddNeuronBtn" class="btn-primary py-3 px-6 rounded-lg text-lg font-semibold shadow-md hover:shadow-lg transition duration-300 ease-in-out">
                                Ajouter un Neurone
                            </button>
                            <button id="brainFuncClearMemoryBtn" class="btn-secondary py-3 px-6 rounded-lg text-lg font-semibold shadow-md hover:shadow-lg transition duration-300 ease-in-out">
                                Vider la M√©moire des Motifs
                            </button>
                            <button id="brainFuncGoToStatsBtn" class="btn-primary py-3 px-6 rounded-lg text-lg font-semibold shadow-md hover:shadow-lg transition duration-300 ease-in-out">
                                Voir les Statistiques
                            </button>
                            <button id="brainFuncGoToConfigBtn" class="btn-secondary py-3 px-6 rounded-lg text-lg font-semibold shadow-md hover:shadow-lg transition duration-300 ease-in-out">
                                Acc√©der √† la Configuration
                            </button>
                        </div>
                    </div>
                </section>

                <section id="externalServicesContent" class="content-section">
                    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Extensions & Services Externes</h2>
                        <p class="text-gray-600 mb-6">Explorez comment NeuraX-Ultime pourrait interagir avec des syst√®mes externes (int√©grations conceptuelles).</p>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <button class="btn-secondary py-3 px-4 rounded-lg text-base font-semibold shadow-md hover:shadow-lg transition duration-300 ease-in-out external-service-btn" data-service="Google">
                                <span class="mr-2">üåê</span> Google
                            </button>
                            <button class="btn-secondary py-3 px-4 rounded-lg text-base font-semibold shadow-md hover:shadow-lg transition duration-300 ease-in-out external-service-btn" data-service="Gemini">
                                <span class="mr-2">‚ú®</span> Gemini (LLM)
                            </button>
                            <button class="btn-secondary py-3 px-4 rounded-lg text-base font-semibold shadow-md hover:shadow-lg transition duration-300 ease-in-out external-service-btn" data-service="Grok">
                                <span class="mr-2">üí°</span> Grok (LLM)
                            </button>
                            <button class="btn-secondary py-3 px-4 rounded-lg text-base font-semibold shadow-md hover:shadow-lg transition duration-300 ease-in-out external-service-btn" data-service="Ask">
                                <span class="mr-2">‚ùì</span> Ask (Moteur de Recherche)
                            </button>
                            <button class="btn-secondary py-3 px-4 rounded-lg text-base font-semibold shadow-md hover:shadow-lg transition duration-300 ease-in-out external-service-btn" data-service="Cloud AI">
                                <span class="mr-2">‚òÅÔ∏è</span> Cloud AI (GCP)
                            </button>
                            <button class="btn-secondary py-3 px-4 rounded-lg text-base font-semibold shadow-md hover:shadow-lg transition duration-300 ease-in-out external-service-btn" data-service="Gamma AI">
                                <span class="mr-2">‚öõÔ∏è</span> Gamma AI
                            </button>
                            <button class="btn-secondary py-3 px-4 rounded-lg text-base font-semibold shadow-md hover:shadow-lg transition duration-300 ease-in-out external-service-btn" data-service="Google Lens">
                                <span class="mr-2">üì∏</span> Google Lens
                            </button>
                            <button class="btn-secondary py-3 px-4 rounded-lg text-base font-semibold shadow-md hover:shadow-lg transition duration-300 ease-in-out external-service-btn" data-service="Google Home">
                                <span class="mr-2">üè†</span> Google Home
                            </button>
                            <button class="btn-secondary py-3 px-4 rounded-lg text-base font-semibold shadow-md hover:shadow-lg transition duration-300 ease-in-out external-service-btn" data-service="Google Authenticator">
                                <span class="mr-2">üîê</span> Google Authenticator
                            </button>
                            <button class="btn-secondary py-3 px-4 rounded-lg text-base font-semibold shadow-md hover:shadow-lg transition duration-300 ease-in-out external-service-btn" data-service="Google Analytics">
                                <span class="mr-2">üìä</span> Google Analytics
                            </button>
                            <button class="btn-secondary py-3 px-4 rounded-lg text-base font-semibold shadow-md hover:shadow-lg transition duration-300 ease-in-out external-service-btn" data-service="Google One">
                                <span class="mr-2">‚òÅÔ∏è</span> Google One
                            </button>
                            <button class="btn-secondary py-3 px-4 rounded-lg text-base font-semibold shadow-md hover:shadow-lg transition duration-300 ease-in-out external-service-btn" data-service="Google Go">
                                <span class="mr-2">üîç</span> Google Go
                            </button>
                        </div>
                    </div>
                </section>

                <section id="logsContent" class="content-section">
                    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Journal d'Activit√© du R√©seau</h2>
                        <div id="logBody" class="bg-gray-50 p-4 rounded-lg h-96 overflow-y-auto custom-scrollbar text-sm text-gray-800 font-mono">
                            <p class="text-gray-500"><em>Le journal affichera l'activit√© du r√©seau...</em></p>
                        </div>
                        <button id="clearLogsBtn" class="btn-secondary py-2 px-4 rounded-lg mt-4">Effacer le Journal</button>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <div id="activationModal" class="modal fixed inset-0 flex items-center justify-center hidden">
        <div class="modal-content bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full text-center">
            <h3 class="text-xl font-bold mb-4">Activation du Syst√®me NeuraX</h3>
            <p class="mb-4">Choisissez un niveau d'initialisation pour le r√©seau (influence le taux de croissance).</p>
            <input type="range" id="activationLevel" min="1" max="100" value="50" class="w-full accent-primary">
            <p class="text-sm text-gray-600 mt-1">Niveau: <span id="currentActivationLevel">50</span>%</p>

            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancelActivation" class="btn-secondary py-2 px-4 rounded-lg">Annuler</button>
                <button id="confirmActivation" class="btn-primary py-2 px-4 rounded-lg">Confirmer</button>
            </div>
        </div>
    </div>

    <div id="toastContainer" class="toast-container space-y-3"></div>

    <script>
        // Configuration avanc√©e du r√©seau neural
        const neuralConfig = {
            neurons: {
                count: 0,
                maxCount: 300,
                baseSize: 2,
                activeSize: 4,
                colors: ['#3498db', '#9b59b6', '#2ecc71'], // Blue, Purple, Green
                speed: 0.3, // Movement speed
                lifespanFactor: 1000, // How long neurons "live"
                mutationRate: 0.02 // Chance of mutation on replication
            },
            synapses: {
                color: '#ccc',
                width: 1,
                activeWidth: 2,
                opacity: 0.1,
                activeOpacity: 0.5
            },
            growthRate: 15, // Neurons added every 5 seconds
            connectionDistance: 180, // Max distance for connections
            systemHealth: 100, // Initial system health
            isActive: false, // System operational status
            replicationProgress: 0 // Progress towards next replication event
        };

        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menuToggle');
        const navItems = document.querySelectorAll('.nav-item');
        const contentSections = document.querySelectorAll('.content-section');
        const startBtn = document.getElementById('startBtn');
        const deactivateBtn = document.getElementById('deactivateBtn');
        const systemHealthText = document.getElementById('systemHealthText');
        const systemHealthBar = document.getElementById('systemHealthBar');
        const neuralCanvas = document.getElementById('neuralCanvas');
        const neuronInfoTooltip = document.getElementById('neuronInfoTooltip');
        const neuronCountSpan = document.getElementById('neuronCount');
        const synapseCountSpan = document.getElementById('synapseCount');
        const replicationProgress = document.getElementById('replicationProgress');
        const chatBody = document.getElementById('chatBody');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const voiceActiveDot = document.querySelector('.voice-active-dot');
        const logBody = document.getElementById('logBody');
        const clearLogsBtn = document.getElementById('clearLogsBtn');
        const activationModal = document.getElementById('activationModal');
        const activationLevelSlider = document.getElementById('activationLevel');
        const currentActivationLevelSpan = document.getElementById('currentActivationLevel');
        const cancelActivationBtn = document.getElementById('cancelActivation');
        const confirmActivationBtn = document.getElementById('confirmActivation');
        const toastContainer = document.getElementById('toastContainer');

        // Config Sliders
        const configMaxNeurons = document.getElementById('configMaxNeurons');
        const currentMaxNeurons = document.getElementById('currentMaxNeurons');
        const configNeuronSpeed = document.getElementById('configNeuronSpeed');
        const currentNeuronSpeed = document.getElementById('currentNeuronSpeed');
        const configGrowthRate = document.getElementById('configGrowthRate');
        const currentGrowthRate = document.getElementById('currentGrowthRate');
        const configConnectionDistance = document.getElementById('configConnectionDistance');
        const currentConnectionDistance = document.getElementById('currentConnectionDistance');
        const configLifespanFactor = document.getElementById('configLifespanFactor');
        const currentLifespanFactor = document.getElementById('currentLifespanFactor');
        const configMutationRate = document.getElementById('configMutationRate');
        const currentMutationRate = document.getElementById('currentMutationRate');

        // Stats Spans
        const statNeuronCount = document.getElementById('statNeuronCount');
        const statConnectionCount = document.getElementById('statConnectionCount');
        const statActiveNeurons = document.getElementById('statActiveNeurons');
        const statAverageEnergy = document.getElementById('statAverageEnergy');
        const statNetworkDensity = document.getElementById('statNetworkDensity');
        const statRecognizedPatterns = document.getElementById('statRecognizedPatterns');
        const statMemorySize = document.getElementById('statMemorySize');
        const statSystemStatus = document.getElementById('statSystemStatus');
        const statTimestamp = document.getElementById('statTimestamp');
        const refreshStatsBtn = document.getElementById('refreshStatsBtn');

        // Brain Function Buttons
        const brainFuncActivateBtn = document.getElementById('brainFuncActivateBtn');
        const brainFuncDeactivateBtn = document.getElementById('brainFuncDeactivateBtn');
        const brainFuncAddNeuronBtn = document.getElementById('brainFuncAddNeuronBtn');
        const brainFuncClearMemoryBtn = document.getElementById('brainFuncClearMemoryBtn');
        const brainFuncGoToStatsBtn = document.getElementById('brainFuncGoToStatsBtn');
        const brainFuncGoToConfigBtn = document.getElementById('brainFuncGoToConfigBtn');

        // Canvas and Neural Network Variables
        let ctx;
        let neurons = [];
        let connections = [];
        let animationFrameId;

        // Speech Recognition (Web Speech API)
        let recognition;
        let isListening = false;

        /**
         * Initializes the canvas and sets up the drawing context.
         */
        function initCanvas() {
            const container = neuralCanvas.parentElement;
            neuralCanvas.width = container.clientWidth;
            neuralCanvas.height = container.clientHeight;
            ctx = neuralCanvas.getContext('2d');
            // Add event listener for clicks to add neurons
            neuralCanvas.addEventListener('click', addNeuronOnClick);
            // Add event listeners for hover to show tooltip
            neuralCanvas.addEventListener('mousemove', showNeuronTooltip);
            neuralCanvas.addEventListener('mouseleave', hideNeuronTooltip);
        }

        /**
         * Handles window resizing to maintain canvas responsiveness.
         */
        function onWindowResize() {
            const container = neuralCanvas.parentElement;
            neuralCanvas.width = container.clientWidth;
            neuralCanvas.height = container.clientHeight;
            // Redraw content if necessary
            drawNetwork();
        }

        /**
         * Represents a single neuron in the neural network.
         * @class
         */
        class Neuron {
            constructor(x, y) {
                this.id = Date.now() + Math.random();
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * neuralConfig.neurons.speed;
                this.vy = (Math.random() - 0.5) * neuralConfig.neurons.speed;
                this.size = neuralConfig.neurons.baseSize;
                this.color = neuralConfig.neurons.colors[Math.floor(Math.random() * neuralConfig.neurons.colors.length)];
                this.lifespan = neuralConfig.neurons.lifespanFactor + Math.random() * neuralConfig.neurons.lifespanFactor; // Random lifespan
                this.age = 0;
                this.active = false;
                this.energy = 0; // Represents activity level
            }

            /**
             * Updates the neuron's position, size, and color based on its state.
             * @param {number} deltaTime - Time elapsed since last frame.
             */
            update(deltaTime) {
                if (!neuralConfig.isActive) return;

                this.x += this.vx * deltaTime;
                this.y += this.vy * deltaTime;

                // Bounce off canvas boundaries
                if (this.x < 0 || this.x > neuralCanvas.width) this.vx *= -1;
                if (this.y < 0 || this.y > neuralCanvas.height) this.vy *= -1;

                this.age += deltaTime;
                if (this.age > this.lifespan) {
                    return true; // Indicate neuron should be removed
                }

                // Simulate energy/activity
                this.energy = Math.max(0, this.energy + (Math.random() - 0.5) * 0.1); // Fluctuate energy
                this.active = this.energy > 0.5; // Neuron is "active" if energy is above threshold

                // Update size based on activity
                this.size = this.active ? neuralConfig.neurons.activeSize : neuralConfig.neurons.baseSize;
                return false;
            }

            /**
             * Draws the neuron on the canvas.
             */
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.closePath();

                if (this.active) {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size + 2, 0, Math.PI * 2);
                    ctx.strokeStyle = 'rgba(255, 255, 0, 0.7)'; // Yellow glow
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    ctx.closePath();
                }
            }
        }

        /**
         * Represents a connection (synapse) between two neurons.
         * @class
         */
        class Connection {
            constructor(neuronA, neuronB) {
                this.neuronA = neuronA;
                this.neuronB = neuronB;
                this.active = false;
                this.opacity = neuralConfig.synapses.opacity;
                this.width = neuralConfig.synapses.width;
            }

            /**
             * Updates the connection's visual state based on neuron activity.
             */
            update() {
                if (!neuralConfig.isActive) return;
                // Activate connection if both neurons are active
                this.active = this.neuronA.active && this.neuronB.active;
                this.opacity = this.active ? neuralConfig.synapses.activeOpacity : neuralConfig.synapses.opacity;
                this.width = this.active ? neuralConfig.synapses.activeWidth : neuralConfig.synapses.width;
            }

            /**
             * Draws the connection on the canvas.
             */
            draw() {
                ctx.beginPath();
                ctx.moveTo(this.neuronA.x, this.neuronA.y);
                ctx.lineTo(this.neuronB.x, this.neuronB.y);
                ctx.strokeStyle = `rgba(204, 204, 204, ${this.opacity})`; // Grey with varying opacity
                ctx.lineWidth = this.width;
                ctx.stroke();
                ctx.closePath();
            }
        }

        /**
         * Adds a new neuron to the network at a random position or at specified coordinates.
         */
        function addNeuron(x = null, y = null) {
            if (neurons.length >= neuralConfig.neurons.maxCount) {
                showToast('Capacit√© maximale de neurones atteinte.', 'warning');
                return;
            }

            if (x === null || y === null) {
                x = Math.random() * neuralCanvas.width;
                y = Math.random() * neuralCanvas.height;
            }
            const newNeuron = new Neuron(x, y);
            neurons.push(newNeuron);
            logActivity(`[D√©ploiement] Nouveau neurone #${newNeuron.id.toFixed(0)} d√©ploy√©.`);
            updateCounts();
            showToast('Neurone d√©ploy√© !', 'success');
        }

        /**
         * Event handler for adding a neuron on canvas click.
         * @param {MouseEvent} event - The click event.
         */
        function addNeuronOnClick(event) {
            if (!neuralConfig.isActive) {
                showToast('Le syst√®me n\'est pas actif. Veuillez le d√©marrer.', 'error');
                return;
            }
            const rect = neuralCanvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            addNeuron(x, y);
        }

        /**
         * Connects newly added neurons to existing ones if they are within connection distance.
         */
        function updateConnections() {
            connections = []; // Clear existing connections for simplicity

            for (let i = 0; i < neurons.length; i++) {
                for (let j = i + 1; j < neurons.length; j++) {
                    const n1 = neurons[i];
                    const n2 = neurons[j];
                    const distance = Math.sqrt(Math.pow(n1.x - n2.x, 2) + Math.pow(n1.y - n2.y, 2));

                    if (distance < neuralConfig.connectionDistance) {
                        connections.push(new Connection(n1, n2));
                    }
                }
            }
            updateCounts();
        }

        /**
         * The main animation loop for the neural network visualization.
         */
        function animateNetwork() {
            animationFrameId = requestAnimationFrame(animateNetwork);

            ctx.clearRect(0, 0, neuralCanvas.width, neuralCanvas.height); // Clear canvas

            const deltaTime = 1; // Simulate a fixed time step for simplicity

            // Update and draw neurons
            const neuronsToRemove = [];
            neurons.forEach((neuron, index) => {
                if (neuron.update(deltaTime)) {
                    neuronsToRemove.push(index);
                }
                neuron.draw();
            });

            // Remove dying neurons
            for (let i = neuronsToRemove.length - 1; i >= 0; i--) {
                neurons.splice(neuronsToRemove[i], 1);
            }

            // Update and draw connections
            updateConnections(); // Re-create connections each frame for simplicity
            connections.forEach(connection => {
                connection.update();
                connection.draw();
            });
        }

        /**
         * Updates the neuron and synapse counts in the UI.
         */
        function updateCounts() {
            neuronCountSpan.textContent = neurons.length;
            synapseCountSpan.textContent = connections.length;
            statNeuronCount.textContent = neurons.length;
            statConnectionCount.textContent = connections.length;
            statActiveNeurons.textContent = neurons.filter(n => n.active).length;
            const totalEnergy = neurons.reduce((sum, n) => sum + n.energy, 0);
            statAverageEnergy.textContent = (neurons.length > 0 ? (totalEnergy / neurons.length).toFixed(2) : '0.00');
            statNetworkDensity.textContent = (neurons.length > 1 ? (connections.length / (neurons.length * (neurons.length - 1) / 2) * 100).toFixed(2) : '0.00') + '%';
            statSystemStatus.textContent = neuralConfig.isActive ? 'Op√©rationnel' : 'Hors Ligne';
            statTimestamp.textContent = new Date().toLocaleTimeString();
        }

        /**
         * Updates the system health bar and text.
         */
        function updateSystemHealth() {
            const health = neuralConfig.systemHealth;
            systemHealthBar.style.width = `${health}%`;
            systemHealthText.textContent = `${health}%`;

            systemHealthBar.classList.remove('low', 'medium');
            if (health < 30) {
                systemHealthBar.classList.add('low');
                systemHealthText.classList.add('text-red-500'); // Tailwind red
                systemHealthText.classList.remove('text-primary', 'text-yellow-500');
            } else if (health < 60) {
                systemHealthBar.classList.add('medium');
                systemHealthText.classList.add('text-yellow-500'); // Tailwind yellow
                systemHealthText.classList.remove('text-primary', 'text-red-500');
            } else {
                systemHealthText.classList.add('text-primary');
                systemHealthText.classList.remove('text-yellow-500', 'text-red-500');
            }
        }

        /**
         * Manages the replication progress bar and triggers neuron replication.
         */
        function handleReplicationProgress() {
            if (!neuralConfig.isActive) return;

            neuralConfig.replicationProgress += 1; // Increment progress
            if (neuralConfig.replicationProgress > 100) {
                // Trigger replication
                const numToReplicate = Math.floor(neuralConfig.growthRate / 10); // Add a few neurons at once
                for (let i = 0; i < numToReplicate; i++) {
                    addNeuron();
                }
                logActivity(`[R√©plication] ${numToReplicate} neurones r√©pliqu√©s.`);
                neuralConfig.replicationProgress = 0; // Reset progress
            }
            replicationProgress.style.width = `${neuralConfig.replicationProgress}%`;
        }

        /**
         * Displays a temporary tooltip with neuron information on hover.
         * @param {MouseEvent} event - The mouse move event.
         */
        function showNeuronTooltip(event) {
            const rect = neuralCanvas.getBoundingClientRect();
            const mouseX = event.clientX - rect.left;
            const mouseY = event.clientY - rect.top;

            let hoveredNeuron = null;
            for (const neuron of neurons) {
                const distance = Math.sqrt(Math.pow(mouseX - neuron.x, 2) + Math.pow(mouseY - neuron.y, 2));
                if (distance < neuron.size + 5) { // Add some padding for easier hover
                    hoveredNeuron = neuron;
                    break;
                }
            }

            if (hoveredNeuron) {
                neuronInfoTooltip.classList.add('visible');
                neuronInfoTooltip.style.left = `${event.clientX + 10}px`;
                neuronInfoTooltip.style.top = `${event.clientY - 10}px`;
                neuronInfoTooltip.innerHTML = `
                    <strong>ID:</strong> ${hoveredNeuron.id.toFixed(0).slice(-4)}<br>
                    <strong>Actif:</strong> ${hoveredNeuron.active ? 'Oui' : 'Non'}<br>
                    <strong>√ânergie:</strong> ${hoveredNeuron.energy.toFixed(2)}<br>
                    <strong>√Çge:</strong> ${(hoveredNeuron.age / 60).toFixed(1)}s
                `;
            } else {
                neuronInfoTooltip.classList.remove('visible');
            }
        }

        /**
         * Hides the neuron information tooltip.
         */
        function hideNeuronTooltip() {
            neuronInfoTooltip.classList.remove('visible');
        }

        /**
         * Adds a message to the chat interface.
         * @param {string} sender - 'user' or 'ai'.
         * @param {string} message - The message content.
         */
        function addChatMessage(sender, message) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', sender, 'rounded-lg', 'mb-2', 'p-3');
            messageDiv.innerHTML = `<p class="text-sm">${sender === 'user' ? 'Vous' : 'IA'} : ${message}</p>`;
            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight; // Scroll to bottom
        }

        /**
         * Displays a temporary toast notification.
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'error', or 'info'.
         */
        function showToast(message, type = 'info') {
            const toastDiv = document.createElement('div');
            toastDiv.classList.add('toast', type, 'p-4', 'rounded-lg', 'shadow-lg', 'mb-3');
            toastDiv.textContent = message;
            toastContainer.appendChild(toastDiv);

            setTimeout(() => {
                toastDiv.classList.add('fade-out');
                toastDiv.addEventListener('animationend', () => toastDiv.remove());
            }, 3000); // Toast disappears after 3 seconds
        }

        /**
         * Adds an entry to the activity log.
         * @param {string} message - The log message.
         */
        function logActivity(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('p');
            logEntry.classList.add('mb-1');
            logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
            logBody.appendChild(logEntry);
            logBody.scrollTop = logBody.scrollHeight; // Scroll to bottom
        }

        // Event Listeners

        // Sidebar toggle for mobile
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        // Navigation item click handler
        navItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                // Remove active from all nav items
                navItems.forEach(nav => nav.classList.remove('active'));
                // Add active to clicked item
                this.classList.add('active');

                // Hide all content sections
                contentSections.forEach(section => section.classList.remove('active'));
                // Show the target content section
                const targetId = this.dataset.targetContent;
                document.getElementById(targetId).classList.add('active');

                // Hide sidebar on mobile after selection
                if (window.innerWidth < 768) {
                    sidebar.classList.remove('open');
                }
            });
        });

        // Start/Deactivate System Buttons
        startBtn.addEventListener('click', () => {
            activationModal.classList.remove('hidden');
        });

        cancelActivationBtn.addEventListener('click', () => {
            activationModal.classList.add('hidden');
        });

        confirmActivationBtn.addEventListener('click', () => {
            neuralConfig.isActive = true;
            neuralConfig.systemHealth = 100;
            neuralConfig.growthRate = activationLevelSlider.value / 100 * 50 + 10; // Scale growth based on activation level
            updateSystemHealth();
            startBtn.classList.add('hidden');
            deactivateBtn.classList.remove('hidden');
            activationModal.classList.add('hidden');
            logActivity(`[Syst√®me] NeuraX-Ultime activ√© au niveau ${activationLevelSlider.value}%.`);
            showToast('NeuraX-Ultime activ√© !', 'success');

            // Initial neuron deployment
            for (let i = 0; i < 50; i++) { // Deploy initial 50 neurons
                addNeuron();
            }
        });

        deactivateBtn.addEventListener('click', () => {
            neuralConfig.isActive = false;
            neuralConfig.systemHealth = 0;
            updateSystemHealth();
            deactivateBtn.classList.add('hidden');
            startBtn.classList.remove('hidden');
            logActivity('[Syst√®me] NeuraX-Ultime d√©sactiv√©.');
            showToast('NeuraX-Ultime d√©sactiv√©.', 'error');
            // Clear neurons and connections
            neurons = [];
            connections = [];
            updateCounts();
        });

        // Activation Level Slider in Modal
        activationLevelSlider.addEventListener('input', () => {
            currentActivationLevelSpan.textContent = activationLevelSlider.value;
        });

        // Chat functionality
        sendBtn.addEventListener('click', () => {
            const message = chatInput.value.trim();
            if (message) {
                addChatMessage('user', message);
                chatInput.value = '';
                // Simulate AI response
                setTimeout(() => {
                    addChatMessage('ai', `Message re√ßu. Traitement de la requ√™te "${message}" en cours.`);
                    logActivity(`[Comms] Requ√™te IA : "${message.substring(0, 30)}..."`);
                }, 1000);
            }
        });

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });

        // Voice input (Web Speech API)
        voiceBtn.addEventListener('click', () => {
            if (!('webkitSpeechRecognition' in window)) {
                showToast('API de reconnaissance vocale non support√©e par ce navigateur.', 'error');
                return;
            }

            if (!recognition) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false; // Listen for a single phrase
                recognition.interimResults = false; // Only return final results
                recognition.lang = 'fr-FR'; // French

                recognition.onstart = () => {
                    isListening = true;
                    voiceActiveDot.classList.remove('hidden');
                    showToast('√âcoute active...', 'info');
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    chatInput.value = transcript;
                    sendBtn.click();
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    showToast(`Erreur vocale: ${event.error}`, 'error');
                    isListening = false;
                    voiceActiveDot.classList.add('hidden');
                };

                recognition.onend = () => {
                    isListening = false;
                    voiceActiveDot.classList.add('hidden');
                    showToast('√âcoute termin√©e.', 'info');
                };
            }

            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });

        // Clear Logs Button
        clearLogsBtn.addEventListener('click', () => {
            logBody.innerHTML = '<p class="text-gray-500"><em>[00:00:01] Journal purg√©.</em></p>';
            showToast('Journal d\'activit√© purg√©.', 'info');
        });

        // Config Sliders Event Listeners
        configMaxNeurons.addEventListener('input', () => {
            neuralConfig.neurons.maxCount = parseInt(configMaxNeurons.value);
            currentMaxNeurons.textContent = neuralConfig.neurons.maxCount;
        });
        configNeuronSpeed.addEventListener('input', () => {
            neuralConfig.neurons.speed = parseFloat(configNeuronSpeed.value);
            currentNeuronSpeed.textContent = neuralConfig.neurons.speed.toFixed(1);
        });
        configGrowthRate.addEventListener('input', () => {
            neuralConfig.growthRate = parseInt(configGrowthRate.value);
            currentGrowthRate.textContent = neuralConfig.growthRate;
        });
        configConnectionDistance.addEventListener('input', () => {
            neuralConfig.connectionDistance = parseInt(configConnectionDistance.value);
            currentConnectionDistance.textContent = neuralConfig.connectionDistance;
            updateConnections(); // Recalculate connections immediately
        });
        configLifespanFactor.addEventListener('input', () => {
            neuralConfig.neurons.lifespanFactor = parseInt(configLifespanFactor.value);
            currentLifespanFactor.textContent = neuralConfig.neurons.lifespanFactor;
        });
        configMutationRate.addEventListener('input', () => {
            neuralConfig.neurons.mutationRate = parseFloat(configMutationRate.value);
            currentMutationRate.textContent = neuralConfig.neurons.mutationRate.toFixed(3);
        });

        // Stats Refresh Button
        refreshStatsBtn.addEventListener('click', updateCounts);

        // Brain Function Buttons (navigate to sections)
        brainFuncActivateBtn.addEventListener('click', () => startBtn.click()); // Reuse existing start logic
        brainFuncDeactivateBtn.addEventListener('click', () => deactivateBtn.click()); // Reuse existing deactivate logic
        brainFuncAddNeuronBtn.addEventListener('click', () => addNeuron());
        brainFuncClearMemoryBtn.addEventListener('click', () => {
            // Placeholder for memory clearing logic
            statRecognizedPatterns.textContent = '0';
            statMemorySize.textContent = '0 KB';
            logActivity('[Protocole] M√©moire des motifs purg√©e.');
            showToast('M√©moire des motifs purg√©e.', 'success');
        });
        brainFuncGoToStatsBtn.addEventListener('click', () => {
            document.querySelector('.nav-item[data-target-content="statsContent"]').click();
        });
        brainFuncGoToConfigBtn.addEventListener('click', () => {
            document.querySelector('.nav-item[data-target-content="configContent"]').click();
        });

        // External Services Buttons (conceptual interaction)
        document.querySelectorAll('.external-service-btn').forEach(button => {
            button.addEventListener('click', function() {
                const serviceName = this.dataset.service;
                logActivity(`[Int√©gration] Tentative de connexion √† ${serviceName}...`);
                showToast(`Connexion √† ${serviceName} initi√©e (conceptuel).`, 'info');
            });
        });


        // Initialize on window load
        window.onload = function() {
            initCanvas();
            animateNetwork(); // Start the animation loop
            onWindowResize(); // Set initial canvas size
            window.addEventListener('resize', onWindowResize); // Handle resize events
            logActivity('[Syst√®me] NeuraX-Ultime : Initialisation du syst√®me.');
            updateSystemHealth(); // Set initial health display
            updateCounts(); // Set initial counts
            setInterval(handleReplicationProgress, 50); // Update replication progress every 50ms
            setInterval(() => { // Simulate system health fluctuations
                if (neuralConfig.isActive) {
                    neuralConfig.systemHealth = Math.max(0, Math.min(100, neuralConfig.systemHealth + (Math.random() - 0.5) * 5));
                    updateSystemHealth();
                    if (neuralConfig.systemHealth < 20) {
                        showToast('Avertissement : Sant√© du syst√®me critique !', 'error');
                        logActivity('[ALERTE] Sant√© du syst√®me critique !');
                    }
                }
            }, 5000); // Update health every 5 seconds
        };
    </script>
</body>
</html>
